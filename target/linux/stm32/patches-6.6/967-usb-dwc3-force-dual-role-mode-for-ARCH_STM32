From 57257911ea14103cb97920e90432db43e71794c0 Mon Sep 17 00:00:00 2001
From: Thomas Richard <thomas.richard@bootlin.com>
Date: Fri, 27 Jun 2025 09:58:28 +0200
Subject: [PATCH] usb: dwc3: force dual-role mode for ARCH_STM32

Force dual-role mode for ARCH_STM32, and disable host and gadget modes.
This patch is a workaround to be able to use dwc3 in dual-role mode.

In OpenWrt core, the package kmod-dwc3 forces host mode. The dwc3 driver
with dual-role mode can be selected builtin in the target/subtarget kernel
configuration. But in case of a build with ALL_KMODS option, the kmod-dwc3
package is built, so the kernel configuration is overrided and host mode is
selected.

define KernelPackage/usb-dwc3
  TITLE:=DWC3 USB controller driver
  KCONFIG:= \
        CONFIG_USB_DWC3 \
        CONFIG_USB_DWC3_HOST=y \
        CONFIG_USB_DWC3_GADGET=n \
        CONFIG_USB_DWC3_DUAL_ROLE=n \

Setting CONFIG_USB_DWC3_HOST, CONFIG_USB_DWC3_GADGET, and
CONFIG_USB_DWC3_DUAL_ROLE are not needed. The kernel automatically selects
the right configuration:
- CONFIG_USB_DWC3_HOST if (USB && !USB_GADGET)
- CONFIG_USB_DWC3_GADGET if (!USB && USB_GADGET)
- CONFIG_USB_DWC3_DUAL_ROLE if (USB && USB_GADGET)

Once it will be fixed upstream, this patch will be removed and the dwc3
driver will be selected as kernel module.

Signed-off-by: Thomas Richard <thomas.richard@bootlin.com>
---
 drivers/usb/dwc3/Kconfig | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/dwc3/Kconfig b/drivers/usb/dwc3/Kconfig
index 44bcbc2c8ef4..bb8dff292968 100644
--- a/drivers/usb/dwc3/Kconfig
+++ b/drivers/usb/dwc3/Kconfig
@@ -25,19 +25,19 @@ config USB_DWC3_ULPI
 choice
 	bool "DWC3 Mode Selection"
 	default USB_DWC3_DUAL_ROLE if (USB && USB_GADGET)
-	default USB_DWC3_HOST if (USB && !USB_GADGET)
-	default USB_DWC3_GADGET if (!USB && USB_GADGET)
+	default USB_DWC3_HOST if (!ARCH_STM32 && USB && !USB_GADGET)
+	default USB_DWC3_GADGET if (!ARCH_STM32 && !USB && USB_GADGET)
 
 config USB_DWC3_HOST
 	bool "Host only mode"
-	depends on USB=y || USB=USB_DWC3
+	depends on !ARCH_STM32 && (USB=y || USB=USB_DWC3)
 	help
 	  Select this when you want to use DWC3 in host mode only,
 	  thereby the gadget feature will be regressed.
 
 config USB_DWC3_GADGET
 	bool "Gadget only mode"
-	depends on USB_GADGET=y || USB_GADGET=USB_DWC3
+	depends on !ARCH_STM32 && (USB_GADGET=y || USB_GADGET=USB_DWC3)
 	help
 	  Select this when you want to use DWC3 in gadget mode only,
 	  thereby the host feature will be regressed.
-- 
2.39.5

